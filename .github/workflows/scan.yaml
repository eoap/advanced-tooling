name: Daily SBOM Scan

on:
#   schedule:
#     # run at 12:23 PM UTC daily
#     - cron: "23 12 * * *"     # Every day at 12:23 UTC
  push:
    branches:
      - develop
      - main
jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install oras
        run: |
          ORAS_VERSION="1.2.2"
          curl -sL "https://github.com/oras-project/oras/releases/download/v${ORAS_VERSION}/oras_${ORAS_VERSION}_linux_amd64.tar.gz" | tar -xz oras
          sudo mv oras /usr/local/bin/

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.4

      - name: Run SBOM scan
        shell: bash
        run: |
          set -euo pipefail

          REF="ghcr.io/eoap/advanced-tooling/app-water-body-cloud-native:0.1.0"
          SBOM_BASE_DIR="attached-sboms"
          mkdir -p "$SBOM_BASE_DIR"

          echo "üîç Discovering SBOM digests for $REF..."
          DIGESTS=$(oras discover --artifact-type application/spdx+json \
              --format json "$REF" | jq -r '.manifests[].digest')

          for digest in $DIGESTS; do
            OUTDIR="$SBOM_BASE_DIR/$digest"
            echo "Pulling $digest ‚Üí $OUTDIR"
            oras pull "$REF@$digest" -o "$OUTDIR"

            SBOM=$(find "$OUTDIR" -name '*.json' | head -n1)
            if [ -f "$SBOM" ]; then
              echo "Scanning SBOM: $SBOM"
              trivy sbom "$SBOM"
            else
              echo "No SBOM found for $digest"
            fi

            rm -rf "$OUTDIR"
          done
